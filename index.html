/* ================= LOAD GRAVES (SINGLE LAYER FIX) ================= */
fetch('data/Graves.geojson')
  .then(r => {
    if (!r.ok) throw new Error("Grave GeoJSON not found");
    return r.json();
  })
  .then(data => {
    // SINGLE LAYER: Handles both the Red Color AND the Clicks
    L.geoJSON(data, {
      interactive: true, // âœ… THIS MAKES IT CLICKABLE
      style: { 
        color: '#ff0000',     // Red outline
        weight: 1.5, 
        fill: true,           // âœ… MUST be true to click the inside
        fillColor: '#ffffff', // White fill
        fillOpacity: 0.01     // âœ… 1% opacity (invisible to eye, but creates a "solid" surface for the mouse)
      },
      onEachFeature: (f, l) => {
        const p = f.properties || {};
        const id = (p.Grave_ID || p.ID || p.id || '').toString();
        const owner = (p.Owner || p.Name || '').toString();
        const streetName = (p.StreetName || '').toString();

        // 1. Setup Popup
        const nav = googleNavLinkFromLayer(l);
        const photoUrl = 'photos/' + encodeURIComponent(id) + '.jpg';
        
        l.bindPopup(`
          <div style="font-family: Arial; min-width: 200px;">
            <h3 style="margin:0 0 5px 0;">Grave ${escapeHtml(id)}</h3>
            ${owner ? `<b>Owner:</b> ${escapeHtml(owner)}<br>` : ``}
            ${streetName ? `<b>Street:</b> ${escapeHtml(streetName)}<br>` : ``}
            <hr style="margin: 8px 0; border: 0; border-top: 1px solid #ddd;">
            <a href="${photoUrl}" target="_blank" style="text-decoration:none; font-weight:bold; color:#0078A8;">ðŸ“· Open Photo</a><br>
            <a href="${nav}" target="_blank" style="text-decoration:none; font-weight:bold; color:#0078A8; margin-top:4px; display:inline-block;">ðŸ§­ Navigate (Google Maps)</a>
          </div>
        `);

        // 2. Add Hover Effect (Turns Yellow when mouse is over it)
        l.on('mouseover', function() { 
            this.setStyle({ color: '#ffeb3b', weight: 3, fillOpacity: 0.2 }); 
            this.bringToFront();
        });
        l.on('mouseout',  function() { 
            this.setStyle({ color: '#ff0000', weight: 1.5, fillOpacity: 0.01 }); 
        });

        // 3. Register for Labels & Search
        l._labelText = id;
        graveVisibleLayers.push(l);
        
        // Add to search index
        gravesIndex.push({
          idLower: id.toLowerCase(),
          ownerLower: owner.toLowerCase(),
          clickLayer: l
        });
        
        // Add suggestions
        if(id) addSuggestion(id);
        if(owner) addSuggestion(owner);
      }
    }).addTo(map);

    // Refresh labels ONLY after data is loaded
    refreshLabels(); 
  })
  .catch(err => console.error("Error loading graves:", err));