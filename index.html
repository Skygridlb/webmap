<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Zgharta Cemetery Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{height:100%;margin:0;}
#map{height:100%;width:100%;}

/* âœ… Click-through labels */
.leaflet-tooltip{pointer-events:none !important;}
.leaflet-interactive{cursor:pointer;}

/* Arabic-friendly font stack */
:root{
  --arabic-font: "Noto Naskh Arabic","Amiri","Arial","Tahoma",sans-serif;
}

/* ================= TOP UI ================= */
#topUI{
  position:fixed;
  top:env(safe-area-inset-top,0px);
  left:0; right:0;
  z-index:2000;
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:10px;
  pointer-events:none;
}
#searchBox{
  background:#fff;
  padding:8px;
  border-radius:14px;
  box-shadow:0 2px 10px rgba(0,0,0,.15);
  display:flex;
  gap:6px;
  align-items:center;
  font-family:Arial,sans-serif;
  pointer-events:auto;
}
#searchInput{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.2);
  font-size:14px;
  outline:none;
}
.searchBtn{
  padding:10px 14px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.2);
  background:#f2f2f2;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
}
.searchBtn:active{background:#ddd;}

/* Partner logo */
#partnerLogo{
  align-self:flex-end;
  background:#fff;
  padding:6px 10px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,.18);
  pointer-events:auto;
}
#partnerLogo img{height:40px;}

/* ================= BRAND CARD ================= */
#brandBox{
  position:fixed;
  bottom:env(safe-area-inset-bottom,10px);
  left:10px; right:10px;
  z-index:2000;
  background:#fff;
  padding:10px 14px;
  border-radius:18px;
  box-shadow:0 4px 16px rgba(0,0,0,.22);
  display:flex;
  gap:14px;
  align-items:center;
  font-family:Arial,sans-serif;
  pointer-events:auto;
}
.brandLogoCol{display:flex;flex-direction:column;align-items:center;gap:4px;}
.poweredBy{font-size:10px;font-weight:800;}
.brandLogoCol img{height:48px;}
.brandText{line-height:1.2;}
.brandName{font-size:14px;font-weight:800;}
.brandRole{font-size:11px;font-weight:600;}
.brandContact{font-size:11px;margin-top:4px;}
.socialRow{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
.socialRow a{
  font-size:10.5px;
  padding:4px 10px;
  border-radius:12px;
  background:rgba(0,0,0,.08);
  text-decoration:none;
  color:#000;
  font-weight:700;
}
.brandTagline{font-size:10px;opacity:.75;margin-top:4px;}

/* ================= LABEL STYLES ================= */
.graveLabel{
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 12px;
  text-shadow: 0 0 3px #fff, 0 0 7px #fff;
  background: rgba(255,255,255,0.0);
}

/* (Street labels will be SVG textPath, style comes from attributes in JS)
   We still keep a class to ensure click-through. */
.streetTextPath{
  pointer-events:none !important;
}
</style>
</head>

<body>

<!-- TOP UI -->
<div id="topUI">
  <div id="searchBox">
    <input id="searchInput" placeholder="Search by Grave_ID">
    <button id="searchBtn" class="searchBtn">Search</button>
    <button id="clearBtn" class="searchBtn">Clear</button>
  </div>

  <div id="partnerLogo">
    <img src="logo/Maronite.png" alt="Maronite">
  </div>
</div>

<!-- BRAND CARD -->
<div id="brandBox">
  <div class="brandLogoCol">
    <div class="poweredBy">Powered by</div>
    <img src="logo/skygridlb.png" alt="Skygridlb">
  </div>

  <div class="brandText">
    <div class="brandName">FADI KASS HANNA</div>
    <div class="brandRole">OWNER | GENERAL MANAGER</div>
    <div class="brandRole">GEO SPATIAL ENGINEER</div>
    <div class="brandContact">
      +961 71 709 417<br>
      fadi@skygridlb.com
    </div>

    <div class="socialRow">
      <a href="https://facebook.com/skygridlb" target="_blank" rel="noopener">Facebook</a>
      <a href="https://instagram.com/skygridlb" target="_blank" rel="noopener">Instagram</a>
      <a href="https://linkedin.com/company/skygridlb" target="_blank" rel="noopener">LinkedIn</a>
    </div>

    <div class="brandTagline">YOUR SPACE â€¢ OUR DATA</div>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- âœ… Needed for parallel labels along lines -->
<script src="https://unpkg.com/leaflet-textpath@1.2.3/leaflet.textpath.js"></script>

<script>
/* ================= SETTINGS (unchanged) ================= */
const MIN_Z = 16;
const MAX_Z = 23;
const GRAVE_LABEL_Z = 22;
const STREET_LABEL_Z = 19;
const GRAVE_CLICK_WEIGHT = 18;

/* ================= MAP ================= */
var map = L.map('map', {
  minZoom: MIN_Z,
  maxZoom: MAX_Z,
  tap: true,
  tapTolerance: 25,
  zoomSnap: 1,
  zoomDelta: 1
}).setView([34.38106, 35.90435], 18);

/* ================= RASTER (unchanged path) ================= */
L.tileLayer('tiles/{z}/{x}/{y}.jpg', {
  minZoom: MIN_Z,
  maxZoom: MAX_Z
}).addTo(map);

/* ================= REGISTRIES ================= */
var graveVisibleLayers = [];
var gravesIndex = [];          // {idLower, clickLayer}
var streetsLayers = [];        // store street line layers

/* ================= HELPERS ================= */
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function googleNavLinkFromLayer(layer){
  let c;
  if (layer.getBounds) c = layer.getBounds().getCenter();
  else if (layer.getLatLng) c = layer.getLatLng();
  else return "";
  const lat = c.lat.toFixed(6);
  const lng = c.lng.toFixed(6);
  return "https://www.google.com/maps/dir/?api=1&destination=" + lat + "," + lng;
}

/* Compute approximate on-screen pixel length of a line */
function linePixelLength(layer){
  const latlngs = layer.getLatLngs();
  const parts = Array.isArray(latlngs[0]) ? latlngs : [latlngs];

  let maxLen = 0;
  parts.forEach(part => {
    let len = 0;
    for(let i=1;i<part.length;i++){
      const a = map.latLngToLayerPoint(part[i-1]);
      const b = map.latLngToLayerPoint(part[i]);
      const dx = b.x - a.x, dy = b.y - a.y;
      len += Math.sqrt(dx*dx + dy*dy);
    }
    if(len > maxLen) maxLen = len;
  });
  return maxLen;
}

/* Apply / clear street label (parallel to line) */
function applyStreetLabel(layer){
  const isMobile = window.matchMedia("(max-width:600px)").matches;
  const fontSize = isMobile ? '20px' : '16px';     // readable on phone + laptop
  const strokeW  = isMobile ? '6' : '5';

  layer.setText(layer._streetName || '', {
    repeat: false,
    center: true,
    offset: -8, // visually "above" the line
    attributes: {
      'class': 'streetTextPath',
      'font-family': '"Noto Naskh Arabic","Amiri","Arial","Tahoma",sans-serif',
      'font-weight': '900',
      'font-size': fontSize,

      /* readable style (similar idea to grave readability) */
      fill: '#111',
      stroke: 'rgba(255,255,255,0.95)',
      'stroke-width': strokeW,
      'paint-order': 'stroke',
      'stroke-linejoin': 'round'
    }
  });

  // ensure SVG text doesn't steal clicks
  setTimeout(() => {
    try{
      const el = layer.getElement();
      if(el){
        const texts = el.querySelectorAll('text, tspan, textPath');
        texts.forEach(t => t.style.pointerEvents = 'none');
      }
    }catch(e){}
  }, 0);
}

function clearStreetLabel(layer){
  layer.setText('');
}

/* ================= LABEL REFRESH ================= */
function refreshLabels(){
  const z = map.getZoom();

  // Graves labels
  graveVisibleLayers.forEach(l=>{
    if(z >= GRAVE_LABEL_Z){
      if(!l.getTooltip()){
        l.bindTooltip(l._labelText || '', {
          permanent:true,
          direction:'center',
          className:'graveLabel'
        });
      }
    }else{
      if(l.getTooltip()) l.unbindTooltip();
    }
  });

  // Streets labels (parallel) + anti-overlap filter
  const showStreets = z >= STREET_LABEL_Z;
  const isMobile = window.matchMedia("(max-width:600px)").matches;
  const minPx = isMobile ? 240 : 180; // only label long lines -> fewer overlaps

  streetsLayers.forEach(l=>{
    if(!showStreets){
      clearStreetLabel(l);
      return;
    }

    const name = (l._streetName || '').trim();
    if(!name){
      clearStreetLabel(l);
      return;
    }

    const pxLen = linePixelLength(l);
    if(pxLen < minPx){
      clearStreetLabel(l);
      return;
    }

    applyStreetLabel(l);
  });
}

map.on('zoomend', refreshLabels);
map.on('moveend', refreshLabels);

/* ================= LOAD GRAVES ================= */
fetch('data/Graves.geojson')
  .then(r => r.json())
  .then(data => {

    // Visible layer (style only)
    L.geoJSON(data,{
      interactive:false,
      style:{color:'#ff0000',weight:2,fillOpacity:0.15},
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        const id=(p.Grave_ID||p.ID||p.Id||p.id||'').toString();
        l._labelText=id;
        graveVisibleLayers.push(l);
      }
    }).addTo(map);

    // Fat invisible click layer (popup + navigation + photo)
    L.geoJSON(data,{
      style:{color:'#000',weight:GRAVE_CLICK_WEIGHT,opacity:0,fillOpacity:0},
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        const id=(p.Grave_ID||p.ID||p.Id||p.id||'').toString();
        const owner=(p.Owner||p.Name||'').toString();

        const nav=googleNavLinkFromLayer(l);
        const photoUrl = 'photos/' + encodeURIComponent(id) + '.jpg';

        l.bindPopup(`
          <b>Grave ID:</b> ${escapeHtml(id)}<br>
          ${owner ? `<b>Owner:</b> ${escapeHtml(owner)}<br>` : ``}
          <br>
          <a href="${photoUrl}" target="_blank" rel="noopener">ðŸ“· Open photo</a><br>
          <a href="${nav}" target="_blank" rel="noopener">ðŸ§­ Navigate (Google Maps)</a>
        `);

        gravesIndex.push({idLower:id.toLowerCase(), clickLayer:l});
      }
    }).addTo(map);

    refreshLabels();
  });

/* ================= LOAD STREETS ================= */
fetch('data/Streets.geojson')
  .then(r => r.json())
  .then(data => {

    L.geoJSON(data,{
      style:{color:'rgb(85,255,0)',weight:3.5,opacity:0.9},
      onEachFeature:(f,l)=>{
        const p=f.properties||{};
        const name=(p.StreetName || p.Name_AR || p.Name || p.NAME || '').toString();
        l._streetName = name;

        l.bindPopup(`<b>Street:</b> ${escapeHtml(name || 'â€”')}`);
        streetsLayers.push(l);
      }
    }).addTo(map);

    refreshLabels();
  });

/* ================= SEARCH ================= */
function doSearch(){
  const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
  if(!q) return;

  const hit =
    gravesIndex.find(x => x.idLower === q) ||
    gravesIndex.find(x => x.idLower.startsWith(q));

  if(hit && hit.clickLayer){
    map.fitBounds(hit.clickLayer.getBounds(), {maxZoom: MAX_Z});
    hit.clickLayer.openPopup();
  }
}

document.getElementById('searchBtn').onclick = doSearch;
document.getElementById('clearBtn').onclick = ()=>{ document.getElementById('searchInput').value=''; };
document.getElementById('searchInput').addEventListener('keydown', e => { if(e.key==='Enter') doSearch(); });

</script>
</body>
</html>
