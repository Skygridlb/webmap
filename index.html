<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Zgharta Cemetery Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{height:100%;margin:0;}
#map{height:100%;width:100%;}

.leaflet-tooltip{pointer-events:none !important;}
.leaflet-interactive{cursor:pointer;}

:root{
  --arabic-font: "Noto Naskh Arabic","Noto Sans Arabic","Amiri","Arial","Tahoma",sans-serif;
}

.graveLabel{
  font-family: Arial;
  font-weight: 900;
  font-size: 12px;
  text-shadow: 0 0 3px #fff, 0 0 7px #fff;
}

.streetText{
  font-family: var(--arabic-font) !important;
  font-weight: 900 !important;
  pointer-events:none !important;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-textpath@1.2.3/leaflet.textpath.js"></script>

<script>

const MIN_Z = 16;
const MAX_Z = 23;
const GRAVE_LABEL_Z = 22;
const STREET_LABEL_Z = 19;
const GRAVE_CLICK_WEIGHT = 18;

var map = L.map('map',{
  minZoom:MIN_Z,
  maxZoom:MAX_Z,
  tap:true,
  tapTolerance:25
}).setView([34.38106,35.90435],18);

L.tileLayer('tiles/{z}/{x}/{y}.jpg',{
  minZoom:MIN_Z,
  maxZoom:MAX_Z
}).addTo(map);

var graveVisibleLayers=[];
var gravesIndex=[];
var streetTextLayers=[];

/* ================= LABEL REFRESH ================= */
function refreshLabels(){
  const z = map.getZoom();

  // Graves
  graveVisibleLayers.forEach(l=>{
    if(z>=GRAVE_LABEL_Z){
      if(!l.getTooltip()){
        l.bindTooltip(l._labelText,{
          permanent:true,
          direction:'center',
          className:'graveLabel'
        });
      }
    }else{
      if(l.getTooltip()) l.unbindTooltip();
    }
  });

  // Streets
  streetTextLayers.forEach(l=>{
    if(z>=STREET_LABEL_Z){
      l.setText(l._streetName,{
        center:true,
        offset:-6,
        attributes:{
          class:'streetText',
          fill:'#ffd400',
          'font-size':window.matchMedia("(max-width:600px)").matches?'22px':'20px',
          'font-weight':'900',
          'font-family':'"Noto Naskh Arabic","Noto Sans Arabic","Amiri","Arial","Tahoma",sans-serif',
          stroke:'rgba(0,0,0,0.85)',
          'stroke-width':'5',
          'paint-order':'stroke',
          'stroke-linejoin':'round'
        }
      });
    }else{
      l.setText('');
    }
  });
}

map.on('zoomend',refreshLabels);

/* ================= LOAD GRAVES ================= */
fetch('data/Graves.geojson')
.then(r=>r.json())
.then(data=>{

  // Visible layer
  L.geoJSON(data,{
    interactive:false,
    style:{color:'#ff0000',weight:2,fillOpacity:0.15},
    onEachFeature:(f,l)=>{
      const id=(f.properties.Grave_ID||f.properties.ID||'').toString();
      l._labelText=id;
      graveVisibleLayers.push(l);
    }
  }).addTo(map);

  // FAT invisible click layer
  L.geoJSON(data,{
    style:{color:'#000',weight:GRAVE_CLICK_WEIGHT,opacity:0,fillOpacity:0},
    onEachFeature:(f,l)=>{
      const id=(f.properties.Grave_ID||f.properties.ID||'').toString();
      const c=l.getBounds().getCenter();
      const nav=`https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}`;
      l.bindPopup(`
        <b>Grave ID:</b> ${id}<br><br>
        <a href="${nav}" target="_blank">ðŸ§­ Navigate (Google Maps)</a>
      `);
      gravesIndex.push({idLower:id.toLowerCase(),clickLayer:l});
    }
  }).addTo(map);

  refreshLabels();
});

/* ================= LOAD STREETS ================= */
fetch('data/Streets.geojson')
.then(r=>r.json())
.then(data=>{

  L.geoJSON(data,{
    style:{color:'rgb(85,255,0)',weight:3.5},
    onEachFeature:(f,l)=>{
      const name=(f.properties.StreetName||f.properties.Name||'').toString();
      l._streetName=name;

      l.bindPopup(`<b>Street:</b> ${name}`);
      streetTextLayers.push(l);
    }
  }).addTo(map);

  refreshLabels();
});

/* ================= SEARCH ================= */
function doSearch(){
  const q=document.getElementById('searchInput')?.value?.trim().toLowerCase();
  if(!q) return;
  const hit=gravesIndex.find(x=>x.idLower===q||x.idLower.startsWith(q));
  if(hit){
    map.fitBounds(hit.clickLayer.getBounds(),{maxZoom:MAX_Z});
    hit.clickLayer.openPopup();
  }
}

</script>
</body>
</html>