<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Zgharta Cemetery Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{ height:100%; margin:0; }
#map{ height:100%; width:100%; }

/* ================= TOP UI ================= */
#topUI{
  position:fixed;
  top:env(safe-area-inset-top,0px);
  left:0; right:0;
  z-index:2000;
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:10px;
  pointer-events:none;
}
#searchBox{
  background:#fff;
  padding:8px;
  border-radius:14px;
  box-shadow:0 2px 10px rgba(0,0,0,.15);
  display:flex;
  gap:6px;
  align-items:center;
  font-family:Arial,sans-serif;
  pointer-events:auto;
}
#searchInput{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.2);
  font-size:14px;
  outline:none;
}
.searchBtn{
  padding:10px 14px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.2);
  background:#f2f2f2;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
}
.searchBtn:active{ background:#ddd; }

/* Street labels along line (textPath) */
.streetText{
  text-shadow: 0 0 2px rgba(0,0,0,0.80), 0 0 7px rgba(0,0,0,0.55);
}

/* Grave tooltip labels */
.graveLabel{
  font-family: Arial, sans-serif;
  font-weight: 800;
  font-size: 11px;
  text-shadow: 0 0 3px #fff, 0 0 7px #fff;
  pointer-events: none;
}
</style>
</head>

<body>

<!-- TOP UI -->
<div id="topUI">
  <div id="searchBox">
    <input id="searchInput" placeholder="Search by Grave_ID">
    <button id="searchBtn" class="searchBtn">Search</button>
    <button id="clearBtn" class="searchBtn">Clear</button>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-textpath@1.2.3/leaflet.textpath.js"></script>

<script>
/* ================= SETTINGS ================= */
const MIN_Z = 16;
const MAX_Z = 23;

// labels by zoom
const STREET_LABEL_Z = 18;
const GRAVE_LABEL_Z  = 22;

// tiles
const TILES_MAX_NATIVE_Z = 21; // change if you truly have tiles/22 or tiles/23 folders

// street style & label style
const STREET_COLOR = 'rgb(85,255,0)'; // requested
const STREET_WEIGHT = 2.5;

const STREET_LABEL_SIZE = '16px';
const STREET_LABEL_WEIGHT = '900';

/* ================= MAP ================= */
var map = L.map('map', {
  minZoom: MIN_Z,
  maxZoom: MAX_Z
}).setView([34.38106, 35.90435], 18);

/* ================= RASTER ONLY (NO OSM) ================= */
L.tileLayer('tiles/{z}/{x}/{y}.jpg', {
  minZoom: MIN_Z,
  maxZoom: MAX_Z,
  minNativeZoom: MIN_Z,
  maxNativeZoom: TILES_MAX_NATIVE_Z,
  tms: false   // if tiles don't show, set true
}).addTo(map);

/* ================= REGISTRIES ================= */
var graveLayers = [];
var streetTextLayers = [];
var gravesIndex = []; // {idLower, layer}

/* ================= LABEL REFRESH ================= */
function refreshLabels(){
  const z = map.getZoom();

  // Graves labels
  const showGraves = z >= GRAVE_LABEL_Z;
  graveLayers.forEach(l => {
    if(showGraves){
      if(!l.getTooltip()){
        l.bindTooltip(l._labelText || '', {
          permanent: true,
          direction: 'center',
          className: 'graveLabel',
          opacity: 0.95
        });
      }
    } else {
      if(l.getTooltip()) l.unbindTooltip();
    }
  });

  // Streets labels (textPath)
  const showStreets = z >= STREET_LABEL_Z;
  streetTextLayers.forEach(l => {
    if(showStreets){
      if(!l._streetTextApplied){
        l.setText(l._streetName || '', {
          center: true,
          repeat: false,
          offset: 0,
          attributes: {
            'class': 'streetText',
            fill: STREET_COLOR,
            'font-size': STREET_LABEL_SIZE,
            'font-weight': STREET_LABEL_WEIGHT
          }
        });
        l._streetTextApplied = true;
      }
    } else {
      if(l._streetTextApplied){
        l.setText('');
        l._streetTextApplied = false;
      }
    }
  });
}
map.on('zoomend', refreshLabels);

/* ================= GRAVES ================= */
fetch('data/Graves.geojson')
  .then(r => r.json())
  .then(data => {
    L.geoJSON(data, {
      // red outline only, no fill
      style: () => ({
        color: '#ff0000',
        weight: 1.5,
        fill: false
      }),
      onEachFeature: (feature, layer) => {
        const gid = (feature.properties?.Grave_ID ?? '').toString().trim();

        // label (shows at zoom 22)
        layer._labelText = gid;
        graveLayers.push(layer);

        // popup
        layer.bindPopup(`<b>Grave_ID:</b> ${gid}`);

        // search index
        if(gid) gravesIndex.push({ idLower: gid.toLowerCase(), layer: layer });
      }
    }).addTo(map);

    refreshLabels();
  })
  .catch(err => console.error('Failed loading Graves.geojson', err));

/* ================= STREETS ================= */
/* IMPORTANT: Streets.geojson must be EPSG:4326 (lat/long) to display in Leaflet. */
fetch('data/Streets.geojson')
  .then(r => r.json())
  .then(data => {
    const streetsLayer = L.geoJSON(data, {
      style: () => ({
        color: STREET_COLOR,
        weight: STREET_WEIGHT,
        opacity: 0.95
      }),
      onEachFeature: (feature, layer) => {
        const sname = (feature.properties?.StreetName ?? '').toString().trim();

        // popup
        layer.bindPopup(`<b>StreetName:</b> ${sname}`);

        // register for zoom controlled labels
        layer._streetName = sname;
        layer._streetTextApplied = false;
        streetTextLayers.push(layer);
      }
    }).addTo(map);

    // keep streets above graves
    streetsLayer.bringToFront();

    refreshLabels();
  })
  .catch(err => console.error('Failed loading Streets.geojson', err));

/* ================= SEARCH (by Grave_ID) ================= */
function doSearch(){
  let q = document.getElementById('searchInput').value.trim().toLowerCase();
  if(!q) return;

  let hit = gravesIndex.find(x => x.idLower === q);
  if(hit){
    map.fitBounds(hit.layer.getBounds(), { maxZoom: MAX_Z });
    hit.layer.openPopup();
  } else {
    alert('Grave_ID not found');
  }
}

document.getElementById('searchBtn').onclick = doSearch;
document.getElementById('clearBtn').onclick = () => { document.getElementById('searchInput').value=""; };
document.getElementById('searchInput').addEventListener('keydown', e => { if(e.key==="Enter") doSearch(); });

// initial
refreshLabels();
</script>

</body>
</html>
